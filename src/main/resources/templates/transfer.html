<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Transfert - Pay My Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <nav class="d-flex justify-content-between">
        <h3>Pay My Buddy</h3>
        <div>
            <a href="/transfer" class="me-3 text-primary fw-bold">Transférer</a>
            <a href="/profile" class="me-3 text-dark">Profil</a>
            <a href="/addConnection" class="me-3 text-dark">Ajouter relation</a>
            <a href="#" id="logout" class="text-dark" aria-label="Se déconnecter">Se déconnecter</a>
        </div>
    </nav>

    <h4 class="mt-4">Page de transfert</h4>

    <!-- Formulaire de transfert -->
    <div class="row mt-4">
        <div class="col-md-3">
            <select id="relationSelect" class="form-select">
                <option selected disabled>Sélectionner une relation</option>
                <!-- Relations seront chargées ici -->
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" id="description" class="form-control" placeholder="Description">
        </div>
        <div class="col-md-2">
            <input type="number" id="amount" class="form-control" placeholder="0€" min="1">
        </div>
        <div class="col-md-2">
            <button id="payButton" class="btn btn-primary w-100" >Payer</button>
        </div>
    </div>

    <!-- Historique des transactions -->
    <div class="mt-5">
        <h5>Mes Transactions</h5>
        <table class="table">
            <thead>
            <tr>
                <th>Relations</th>
                <th>Description</th>
                <th>Montant</th>
            </tr>
            </thead>
            <tbody id="transactionsTable">
            <!-- Transactions seront chargées ici -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("token");
    console.log("Token récupéré :", token);

    if (!token) {
        console.warn("Aucun token trouvé, redirection vers /login");
        window.location.href = "/login";
        return;
    }

    if (!token.startsWith("eyJ")) {
        console.error("Token corrompu ou invalide !");
        localStorage.removeItem("token");
        window.location.href = "/login";
        return;
    }

    let userId = null;
    let relationsMap = new Map();

    fetch("/api/users/me", {
        headers: { "Authorization": "Bearer " + token }
    })
    .then(response => response.json())
    .then(user => {
        console.log("Utilisateur connecté :", user);
        userId = user.id;

        return fetch("/api/connections", {
            headers: { "Authorization": "Bearer " + token }
        });
    })
    .then(response => response.json())
    .then(data => {
        console.log("Données relations reçues :", data);
        const select = document.getElementById("relationSelect");

        data.forEach(relation => {
            const option = document.createElement("option");

            option.value = relation.email;
            option.textContent = relation.username;
            select.appendChild(option);

            // Associer l'email à l'ID pour l'envoi
            relationsMap.set(relation.email, relation.id);
        });

        return fetch(`/api/transactions/sent?userId=${userId}`, {
            headers: { "Authorization": "Bearer " + token }
        });
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error("Erreur lors du chargement des transactions : " + text);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log("Transactions chargées :", data);
        const table = document.getElementById("transactionsTable");
        table.innerHTML = '';

        data.forEach(transaction => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${transaction.receiver.username}</td>
                <td>${transaction.description}</td>
                <td>${transaction.amount}€</td>
            `;
            table.appendChild(row);
        });
    })
    .catch(error => console.error("Erreur lors du chargement des données :", error));

    // Gérer le paiement
    document.getElementById("payButton").addEventListener("click", function () {
        const receiverEmail = document.getElementById("relationSelect").value;
        const description = document.getElementById("description").value;
        const amount = parseFloat(document.getElementById("amount").value);

        if (!receiverEmail || isNaN(amount) || amount <= 0) {
            alert("Veuillez sélectionner un destinataire et entrer un montant valide.");
            return;
        }

        const receiverId = relationsMap.get(receiverEmail);
 if (!receiverId) {
        alert("Erreur : Destinataire introuvable.");
        return;
    }
    console.log("Paiement en cours vers :", { senderId: userId, receiverId, amount, description });

        fetch(`/api/transactions/create?senderId=${userId}&receiverId=${receiverId}&amount=${amount}&description=${encodeURIComponent(description)}`,{
            method: "POST",
            headers: {

                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                senderId: userId,
                receiverId: receiverId,
                amount,
                description
            })
        })
        .then(response => {
            if (!response.ok) return response.text().then(text => { throw new Error(text); });
            return response.text();
        })
        .then(() => {
            alert("Transfert réussi !");
            window.location.reload();
        })
        .catch(error => {
            alert("Erreur lors du transfert : " + error.message);
            console.error(error);
        });
    });

    // Gérer la déconnexion
    document.getElementById("logout").addEventListener("click", function () {
        localStorage.removeItem("token");
        window.location.href = "/login";
    });
});

</script>

</body>
</html>
